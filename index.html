<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Live TfL Bus Times</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" href="favicon.png" type="image/png">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<!-- body contains two tables, with some formatting included -->

<body>

  <div class="tab">
    <button class="tablinks" onclick="openTab(event, 'geolocation')" id="defaultOpen">Nearest stop</button>
    <button class="tablinks" onclick="openTab(event, 'mystops')">Vineet's flat</button>
  </div>

  <div id="mystops" class="tabcontent">
    <h1>Bus times (towards central)</h1>
    <table id="arrivals1">
      <colgroup>
        <col style="width: 15%;">
        <col style="width: 60%;">
        <col style="width: 25%;">
      </colgroup>
      <thead>
        <tr>
          <th>Bus</th>
          <th>Destination</th>
          <th>Arriving in</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="3">Loading...</td>
        </tr>
      </tbody>
    </table>


    <h1>Bus times (southbound)</h1>
    <table id="arrivals2">
      <colgroup>
        <col style="width: 15%;">
        <col style="width: 60%;">
        <col style="width: 25%;">
      </colgroup>
      <thead>
        <tr>
          <th>Bus</th>
          <th>Destination</th>
          <th>Arriving in</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="3">Loading...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div id="geolocation" class="tabcontent">
    <h1 id="nearestName">Loading stop info... </h1>
    <table id="arrivals3">
      <colgroup>
        <col style="width: 15%;">
        <col style="width: 60%;">
        <col style="width: 25%;">
      </colgroup>
      <thead>
        <tr>
          <th>Bus</th>
          <th>Destination</th>
          <th>Arriving in</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="3">Loading...</td>
        </tr>
      </tbody>
    </table>
  </div>
  </div>


  <!-- Script to allow toggling between tabs -->
  <script>
    function openTab(evt, tabName) {
      // Declare all variables
      var i, tabcontent, tablinks;

      // Get all elements with class="tabcontent" and hide them
      tabcontent = document.getElementsByClassName("tabcontent");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }

      // Get all elements with class="tablinks" and remove the class "active"
      tablinks = document.getElementsByClassName("tablinks");
      for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }

      // Show the current tab, and add an "active" class to the button that opened the tab
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.className += " active";
    }
  </script>

  <!-- Get the element with id="defaultOpen" and click on it-->
  <script>
    document.getElementById("defaultOpen").click();
  </script>


  <!-- Find geolocation -->
  <script>
    navigator.geolocation.getCurrentPosition(success, error);
    function success(position) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      fetchNearestStop(lat, lon);
    }

    function error() {
      alert("Unable to retrieve your location");
    }
  </script>


  <!-- Find nearest bus stop -->
  <script>
    function fetchNearestStop(lat, lon) {
      const radius = 500; // in metres
      const url = `https://api.tfl.gov.uk/StopPoint?lat=${lat}&lon=${lon}&stopTypes=NaptanPublicBusCoachTram&radius=${radius}&modes=bus`;

      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data.stopPoints.length === 0) {
            console.log("No bus stops found nearby.");
            return;
          }

          // Sort by distance to find the closest
          const nearest = data.stopPoints.sort((a, b) => a.distance - b.distance)[0];

          console.log("Nearest Stop ID:", nearest.id);
          console.log("Stop Name:", nearest.commonName);
          console.log("Indicator:", nearest.indicator);

          // Update heading

          document.getElementById("nearestName").textContent = `Bus times from: ${nearest.commonName} (${nearest.indicator.replace(/[^a-zA-Z]+/g, '')})`;

          // Call arrivals function
          fetchArrivals(nearest.id, "arrivals3");
        })
        .catch(err => console.error("Error fetching stop points:", err));
    }
  </script>


  <!-- JavaScript to pull the data and sort it in the appropriate manner, and add to the table -->

  <script>

    //include my API key. This would be hidden away if the API was paid for/commercially sensitive
    const apiKey = "2d033d1af7b148bda1fbd9860f6f7ba6";

    //function to do the work. takes the relevant stop ID, and the list ID of the table we want to insert into
    function fetchArrivals(stopID, listID) {

      //finds the HTML table element by list ID, where we will insert rows
      const list = document.getElementById(listID);

      // making the API call - GET request to TfL API
      fetch(`https://api.tfl.gov.uk/StopPoint/${stopID}/Arrivals`, {
        headers: {
          "api_key": apiKey
        }
      })

        // response handling: puts it into JSON format
        .then(response => response.json())

        // grab the body of the table to insert rows and clear content
        .then(data => {
          const tbody = list.querySelector("tbody");
          tbody.innerHTML = ""; // Clear "Loading..."

          //message if there are no upcoming buses
          if (data.length === 0) {
            tbody.innerHTML = "<tr><td colspan='3'>No upcoming buses.</td></tr>";
            return;
          }

          // sort the data in order of how soon the buses are coming
          const sorted = data.sort((a, b) => a.timeToStation - b.timeToStation);

          //create and add a row for each arrival
          for (let arrival of sorted) {
            const newRow = document.createElement('tr')

            const lineNameTableElement = document.createElement('td');
            lineNameTableElement.textContent = `${arrival.lineName}`;

            const destinationNameTableElement = document.createElement('td');
            destinationNameTableElement.textContent = `${arrival.destinationName}`;

            const timeToStationTableElement = document.createElement('td');
            timeToStationTableElement.textContent = `${Math.round(arrival.timeToStation / 60)} min`;

            newRow.appendChild(lineNameTableElement);
            newRow.appendChild(destinationNameTableElement);
            newRow.appendChild(timeToStationTableElement);

            tbody.appendChild(newRow);
          }
        })
        // handle errors
        .catch(err => {
          document.getElementById(listID).innerHTML = "Error fetching bus data.";
          console.error(err);
        });
    }

    //use function on three relevant bus stops
    fetchArrivals("490004404N", "arrivals1");
    fetchArrivals("490004404S", "arrivals2");
  </script>

</body>

</html>